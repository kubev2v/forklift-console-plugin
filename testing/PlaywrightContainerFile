FROM mcr.microsoft.com/playwright:v1.55.0-noble

ARG GIT_COMMIT=unknown
ARG BUILD_DATE=unknown
ARG VERSION=dev

LABEL org.opencontainers.image.created="${BUILD_DATE}" \
    org.opencontainers.image.source="https://github.com/kubev2v/forklift-console-plugin" \
    org.opencontainers.image.version="${VERSION}" \
    org.opencontainers.image.revision="${GIT_COMMIT}" \
    org.opencontainers.image.title="MTV UI Tests" 

ENV LC_ALL=en_US \
    IMAGE_VERSION="${VERSION}" \
    IMAGE_GIT_COMMIT="${GIT_COMMIT}" \
    IMAGE_BUILD_DATE="${BUILD_DATE}" \
    NFS_MOUNT_PATH=""

WORKDIR /test-runner

USER root

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates python3 python3-pip \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# Install OpenShift CLI tools
RUN curl -sL https://mirror.openshift.com/pub/openshift-v4/clients/ocp/stable/openshift-client-linux.tar.gz \
    | tar -xz -C /usr/local/bin oc kubectl \
    && chmod +x /usr/local/bin/oc /usr/local/bin/kubectl

# Install Python dependencies for Report Portal
RUN pip3 install --no-cache-dir --break-system-packages \
    PyYAML requests lxml 'reportportal-client~=5.0.0' \
    xmltodict jinja2 packaging setuptools suds-py3

# Clone Report Portal uploader
RUN GIT_SSL_NO_VERIFY=1 git clone \
    https://gitlab.cee.redhat.com/migrationqe/rp-uploader.git \
    /opt/rp-uploader

COPY package.json yarn.lock ./
RUN corepack enable && yarn install --frozen-lockfile --ignore-scripts

COPY . .

RUN chmod +x run-tests.sh upload-to-rp.sh && \
    chown -R 1001:0 /test-runner /opt/rp-uploader && \
    chmod -R g+w /test-runner /opt/rp-uploader

USER 1001

CMD ["./run-tests.sh"]
